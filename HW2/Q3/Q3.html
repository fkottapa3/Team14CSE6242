<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Q3: Axis scales in D3</title>
  <script src="../lib/d3.v5.min.js"></script>
  <style>
    .line { fill: none; stroke-width: 2px; }
    text { font-family: sans-serif; }
    .axis text { font-size: 10px; }
    .axis path, .axis line { fill: none; stroke: #000; shape-rendering: crispEdges; }
    .rank-circle { fill: orange; stroke: #000; stroke-width: 1px; }
  </style>
</head>
<body>
  <!-- Signature -->
  <div id="signature">fkottapa3</div>

  <!-- Q3.1 -->
  <svg id="svg-a"></svg>

  <!-- Q3.2 -->
  <svg id="svg-b"></svg>

  <!-- Q3.3-1 -->
  <svg id="svg-c-1"></svg>

  <!-- Q3.3-2 -->
  <svg id="svg-c-2"></svg>

  <script>
    // Load Data, Build series for rating counts
    d3.csv("boardgame_ratings.csv").then(function(data) {
      const parseTime = d3.timeParse("%Y-%m-%d");
      data.forEach(d => {
         d.date = parseTime(d.date);
         // Count values for all 8 games
         d["Catan"] = +d["Catan=count"] || 0;
         d["Dominion"] = +d["Dominion=count"] || 0;
         d["Codenames"] = +d["Codenames=count"] || 0;
         d["Terraforming Mars"] = +d["Terraforming Mars=count"] || 0;
         d["Gloomhaven"] = +d["Gloomhaven=count"] || 0;
         d["Magic: The Gathering"] = +d["Magic: The Gathering=count"] || 0;
         d["Dixit"] = +d["Dixit=count"] || 0;
         d["Monopoly"] = +d["Monopoly=count"] || 0;
         // Ranking values (for charts 2, 3-1, 3-2) for 4 games
         d["Catan_rank"] = +d["Catan=rank"] || 0;
         d["Codenames_rank"] = +d["Codenames=rank"] || 0;
         d["Terraforming Mars_rank"] = +d["Terraforming Mars=rank"] || 0;
         d["Gloomhaven_rank"] = +d["Gloomhaven=rank"] || 0;
      });

      // Building series for rating counts for all 8 games.
      const games = ["Catan", "Dominion", "Codenames", "Terraforming Mars",
                     "Gloomhaven", "Magic: The Gathering", "Dixit", "Monopoly"];
      const series = games.map(game => ({
         id: game,
         values: data.map(d => ({ date: d.date, count: d[game] }))
      }));
      // For ranking, we care about 4 games:
      const rankGames = ["Catan", "Codenames", "Terraforming Mars", "Gloomhaven"];

      // Color scale for all charts
      const color = d3.scaleOrdinal(d3.schemeCategory10);

      // Chart Dims
      const totalWidth = 960, totalHeight = 500;
      const margin = { top: 50, right: 100, bottom: 50, left: 60 };
      const width = totalWidth - margin.left - margin.right;
      const height = totalHeight - margin.top - margin.bottom;

      // x-scale (all charts)
      const x = d3.scaleTime()
         .domain(d3.extent(data, d => d.date))
         .range([0, width]);


      // Chart 1: Basic Line Chart (Linear Scale)
      const svgA = d3.select("#svg-a")
         .attr("width", totalWidth)
         .attr("height", totalHeight);
      const chartA = svgA.append("g")
         .attr("id", "plot-a")
         .attr("transform", `translate(${margin.left},${margin.top})`);

      // Chart 1 Title
      chartA.append("text")
         .attr("id", "title-a")
         .attr("x", width / 2)
         .attr("y", -15)
         .attr("text-anchor", "middle")
         .style("font-size", "16px")
         .text("Number of Ratings 2016-2020");

      // y-scale for Chart 1: Linear scale
      const y1 = d3.scaleLinear()
         .domain([0, d3.max(series, s => d3.max(s.values, v => v.count))])
         .range([height, 0]);

      const lineGen = d3.line()
         .x(d => x(d.date))
         .y(d => y1(d.count));

      const linesA = chartA.append("g").attr("id", "lines-a");
      series.forEach(s => {
         linesA.append("path")
           .datum(s.values)
           .attr("class", "line")
           .attr("id", "line-" + s.id)
           .attr("fill", "none")
           .attr("stroke", color(s.id))
           .attr("d", lineGen);
         const lastVal = s.values[s.values.length - 1];
         linesA.append("text")
           .attr("x", x(lastVal.date) + 5)
           .attr("y", y1(lastVal.count))
           .attr("fill", color(s.id))
           .style("font-size", "12px")
           .text(s.id);
      });

      // Axes for Chart 1
      const xAxis = d3.axisBottom(x)
         .ticks(d3.timeMonth.every(3))
         .tickFormat(d3.timeFormat("%b '%y"));
      chartA.append("g")
         .attr("id", "x-axis-a")
         .attr("transform", `translate(0,${height})`)
         .call(xAxis)
         .append("text")
         .attr("id", "x-axis-label-a")
         .attr("x", width / 2)
         .attr("y", 40)
         .attr("text-anchor", "middle")
         .text("Month");

      const yAxis = d3.axisLeft(y1);
      chartA.append("g")
         .attr("id", "y-axis-a")
         .call(yAxis)
         .append("text")
         .attr("id", "y-axis-label-a")
         .attr("transform", "rotate(-90)")
         .attr("x", -height / 2)
         .attr("y", -40)
         .attr("text-anchor", "middle")
         .text("Num of Ratings");

      // Chart 2: Line Chart with Rankings (Includes linear scale + rank markers)
      const svgB = d3.select("#svg-b")
         .attr("width", totalWidth)
         .attr("height", totalHeight);
      const chartB = svgB.append("g")
         .attr("id", "plot-b")
         .attr("transform", `translate(${margin.left},${margin.top})`);

      // Chart 2 Title
      chartB.append("text")
         .attr("id", "title-b")
         .attr("x", width / 2)
         .attr("y", -15)
         .attr("text-anchor", "middle")
         .style("font-size", "16px")
         .text("Number of Ratings 2016-2020 with Rankings");

      // Reuse same x scale; y scale is same linear scale as Chart 1
      const yB = y1;  // same as y1

      const lineGenB = d3.line()
         .x(d => x(d.date))
         .y(d => yB(d.count));

      const linesB = chartB.append("g").attr("id", "lines-b");
      series.forEach(s => {
         linesB.append("path")
           .datum(s.values)
           .attr("class", "line")
           .attr("id", "line-" + s.id) // same id as first chart
           .attr("fill", "none")
           .attr("stroke", color(s.id))
           .attr("d", lineGenB);
         const last = s.values[s.values.length - 1];
         linesB.append("text")
           .attr("x", x(last.date) + 5)
           .attr("y", yB(last.count))
           .attr("fill", color(s.id))
           .style("font-size", "12px")
           .text(s.id);
      });

      // Axes for Chart 2
      chartB.append("g")
         .attr("id", "x-axis-b")
         .attr("transform", `translate(0,${height})`)
         .call(xAxis)
         .append("text")
         .attr("id", "x-axis-label-b")
         .attr("x", width / 2)
         .attr("y", 40)
         .attr("text-anchor", "middle")
         .text("Month");
      chartB.append("g")
         .attr("id", "y-axis-b")
         .call(yAxis)
         .append("text")
         .attr("id", "y-axis-label-b")
         .attr("transform", "rotate(-90)")
         .attr("x", -height / 2)
         .attr("y", -40)
         .attr("text-anchor", "middle")
         .text("Num of Ratings");

      // Add ranking markers for specified rankGames
      const symbolsB = chartB.append("g").attr("id", "symbols-b");
      // For each rankGame, draw markers at every data point (or filter as needed)
      rankGames.forEach(game => {
         data.forEach(d => {
            const cx = x(d.date);
            const cy = yB(d[game]);
            const rankVal = d[game + "_rank"];
            // Optionally, only add markers every 3 months:
            // if (d.date.getMonth() % 3 !== 0) return;
            symbolsB.append("circle")
              .attr("class", "rank-circle")
              .attr("cx", cx)
              .attr("cy", cy)
              .attr("r", 4);
            symbolsB.append("text")
              .attr("x", cx + 6)
              .attr("y", cy + 3)
              .style("font-size", "10px")
              .text(rankVal);
         });
      });

      // Add legend for ranking markers in Chart 2
      const legendB = chartB.append("g")
         .attr("id", "legend-b")
         .attr("transform", "translate(800,60)");
      legendB.append("circle")
         .attr("cx", 0)
         .attr("cy", 0)
         .attr("r", 5)
         .attr("fill", "orange")
         .attr("stroke", "#000")
         .attr("stroke-width", 1);
      legendB.append("text")
         .attr("x", 12)
         .attr("y", 4)
         .style("font-size", "12px")
         .text("Ranking marker");

      // Chart 3-1: Square root scale
      const svgC1 = d3.select("#svg-c-1")
         .attr("width", totalWidth)
         .attr("height", totalHeight);
      const chartC1 = svgC1.append("g")
         .attr("id", "plot-c-1")
         .attr("transform", `translate(${margin.left},${margin.top})`);

      chartC1.append("text")
         .attr("id", "title-c-1")
         .attr("x", width / 2)
         .attr("y", -15)
         .attr("text-anchor", "middle")
         .style("font-size", "16px")
         .text("Number of Ratings 2016-2020 (Square root Scale)");

      // y-scale: square root scale
      const yC1 = d3.scaleSqrt()
         .domain([0, d3.max(series, s => d3.max(s.values, v => v.count))])
         .range([height, 0]);

      const lineGenC1 = d3.line()
         .x(d => x(d.date))
         .y(d => yC1(d.count));

      const linesC1 = chartC1.append("g").attr("id", "lines-c-1");
      series.forEach(s => {
         linesC1.append("path")
           .datum(s.values)
           .attr("class", "line")
           .attr("id", "line-" + s.id + "-c1")
           .attr("fill", "none")
           .attr("stroke", color(s.id))
           .attr("d", lineGenC1);
         const lastVal = s.values[s.values.length - 1];
         linesC1.append("text")
           .attr("x", x(lastVal.date) + 5)
           .attr("y", yC1(lastVal.count))
           .attr("fill", color(s.id))
           .style("font-size", "12px")
           .text(s.id);
      });

      // Axes for Chart 3-1
      const xAxisC1 = d3.axisBottom(x)
         .ticks(d3.timeMonth.every(3))
         .tickFormat(d3.timeFormat("%b '%y"));
      chartC1.append("g")
         .attr("id", "x-axis-c-1")
         .attr("transform", `translate(0,${height})`)
         .call(xAxisC1)
         .append("text")
         .attr("id", "x-axis-label-c-1")
         .attr("x", width / 2)
         .attr("y", 40)
         .attr("text-anchor", "middle")
         .text("Month");
      const yAxisC1 = d3.axisLeft(yC1);
      chartC1.append("g")
         .attr("id", "y-axis-c-1")
         .call(yAxisC1)
         .append("text")
         .attr("id", "y-axis-label-c-1")
         .attr("transform", "rotate(-90)")
         .attr("x", -height / 2)
         .attr("y", -40)
         .attr("text-anchor", "middle")
         .text("Num of Ratings");

      // Chart 3-2: Log Scale (Q3.3-2)
      const svgC2 = d3.select("#svg-c-2")
         .attr("width", totalWidth)
         .attr("height", totalHeight);
      const chartC2 = svgC2.append("g")
         .attr("id", "plot-c-2")
         .attr("transform", `translate(${margin.left},${margin.top})`);

      chartC2.append("text")
         .attr("id", "title-c-2")
         .attr("x", width / 2)
         .attr("y", -15)
         .attr("text-anchor", "middle")
         .style("font-size", "16px")
         .text("Number of Ratings 2016-2020 (Log Scale)");

      // y-scale: log scale; domain min set to 1 to avoid log(0)
      const yC2 = d3.scaleLog()
         .domain([1, d3.max(series, s => d3.max(s.values, v => v.count))])
         .range([height, 0]);

      const lineGenC2 = d3.line()
         .x(d => x(d.date))
         .y(d => yC2(d.count));

      const linesC2 = chartC2.append("g").attr("id", "lines-c-2");
      series.forEach(s => {
         linesC2.append("path")
           .datum(s.values)
           .attr("class", "line")
           .attr("id", "line-" + s.id + "-c2")
           .attr("fill", "none")
           .attr("stroke", color(s.id))
           .attr("d", lineGenC2);
         const lastVal = s.values[s.values.length - 1];
         linesC2.append("text")
           .attr("x", x(lastVal.date) + 5)
           .attr("y", yC2(lastVal.count))
           .attr("fill", color(s.id))
           .style("font-size", "12px")
           .text(s.id);
      });

      // Axes for Chart 3-2
      const xAxisC2 = d3.axisBottom(x)
         .ticks(d3.timeMonth.every(3))
         .tickFormat(d3.timeFormat("%b '%y"));
      chartC2.append("g")
         .attr("id", "x-axis-c-2")
         .attr("transform", `translate(0,${height})`)
         .call(xAxisC2)
         .append("text")
         .attr("id", "x-axis-label-c-2")
         .attr("x", width / 2)
         .attr("y", 40)
         .attr("text-anchor", "middle")
         .text("Month");
      const yAxisC2 = d3.axisLeft(yC2)
         .ticks(10, "~s");
      chartC2.append("g")
         .attr("id", "y-axis-c-2")
         .call(yAxisC2)
         .append("text")
         .attr("id", "y-axis-label-c-2")
         .attr("transform", "rotate(-90)")
         .attr("x", -height / 2)
         .attr("y", -40)
         .attr("text-anchor", "middle")
         .text("Num of Ratings");

      // Add GT username to the bottom right of Chart 3-2
      chartC2.append("text")
         .attr("id", "credit")
         .attr("x", width - 10)
         .attr("y", height + 35)
         .attr("text-anchor", "end")
         .style("font-size", "12px")
         .text("fkottapa3");
    });
  </script>
</body>
</html>
