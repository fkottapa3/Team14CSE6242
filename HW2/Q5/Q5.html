<!DOCTYPE html>
<meta charset="utf-8">
<head>
    <title>Wildlife Trafficking Choropleth</title>
    <script src="../lib/d3.v5.min.js"></script>
    <script src="../lib/d3-dsv.min.js"></script>
    <script src="../lib/d3-geo-projection.v2.min.js"></script>    
    <script src="../lib/d3-legend.min.js"></script>
    <script src="../lib/d3-tip.min.js"></script>
    <script src="../lib/topojson.v2.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        #choropleth { width: 900px; height: 500px; }
        #tooltip {
            position: absolute;
            background: white;
            padding: 8px;
            border: 1px solid black;
            pointer-events: none;
            opacity: 0;
        }
        #legend rect { stroke: black; }
    </style>
</head>

<body>
    <h2>Wildlife Trafficking Incidents by Country</h2>
    
    <label for="yearDropdown">Select Year:</label>
    <select id="yearDropdown"></select>
    <svg id="choropleth">
        <g id="countries"></g>
        <g id="legend"></g>
    </svg>
    <div id="tooltip"></div>

    <script>
        const width = 900, height = 500;

        const svg = d3.select("#choropleth")
            .attr("width", width)
            .attr("height", height);

        const projection = d3.geoNaturalEarth1()
            .scale(150)
            .translate([width / 2, height / 2]);

        const path = d3.geoPath().projection(projection);

        const tooltip = d3.select("body").append("div")
            //.attr("id", "tooltip")
            .style("position", "absolute")
            .style("background", "white")
            .style("padding", "8px")
            .style("border", "1px solid black")
            .style("pointer-events", "none")
            .style("opacity", 0);

		Promise.all([
			d3.json("../data/world_countries.json"),
			d3.csv("../data/wildlife_trafficking.csv").then(data => {
				console.log(" Raw CSV Data Sample:", data.slice(0, 5)); // Debug CSV structure
				console.log(" CSV Column Names:", Object.keys(data[0])); // Ensure column names are correct
		
				return data.map(d => ({
					Year: d["Year"] ? d["Year"].trim() : "",
					Country: d["Country of Incident"] ? d["Country of Incident"].trim() : "",
					Incidents: d["Number_of_Incidents"] ? +d["Number_of_Incidents"].trim() : 0,
					Fine: d["Average_Fine"] ? +d["Average_Fine"] : "N/A",
					Imprisonment: d["Average_Imprisonment"] ? +d["Average_Imprisonment"] : "N/A"
				}));
			})
		])
		
		
        .then(([world, traffickingData]) => {
            console.log(" World Data Loaded:", world);
            console.log(" Wildlife Trafficking Data Loaded:", traffickingData);

            if (!world || !world.features) {
                throw new Error("  GeoJSON data is missing or incorrectly formatted");
            }

            ready(world, traffickingData);
        })
        .catch(error => {
            console.error("  Error loading data:", error);
        });

        function ready(world, traffickingData) {
            console.log(" Inside ready():", world);


            if (!world || !world.features) {
                console.error("  Error: world is undefined or missing features");
                return;
            }

            const years = [...new Set(traffickingData.map(d => d.Year))].sort();
            const dropdown = d3.select("#yearDropdown");

            dropdown.selectAll("option")
                .data(years)
                .enter()
                .append("option")
                .attr("value", d => d)
                .text(d => d);

            dropdown.on("change", function() {
                console.log("Year Selected:", this.value);
                createMapAndLegend(world, traffickingData, this.value);
            });

            createMapAndLegend(world, traffickingData, years[0]); // Default year selection
        }
		
		const standardizeCountryName = (name) => {
			const mapping = {
				"United States of America": "USA",
				"Russian Federation": "Russia",
				"United Kingdom": "UK",
				"Democratic Republic of the Congo": "Democratic Republic of the Congo",
				"Republic of the Congo": "Republic of the Congo",
				"United Republic of Tanzania": "Tanzania",
				"South Korea": "Republic of Korea",
				"Ivory Coast": "Côte d'Ivoire",
				"Czech Republic": "Czechia"
			};
			return mapping[name] || name;
		};		

        function createMapAndLegend(world, traffickingData, selectedYear) {
            if (!world || !world.features) {
                console.error("  Error: World data is undefined inside createMapAndLegend.");
                return;
            }
			
			console.log(" Checking Country Names:");
			
			// Check the first country in GeoJSON
			console.log(" First GeoJSON Country:", world.features[0]?.properties?.name);
		

		
			// Verify that multiple country names exist in both datasets
			console.log(" Sample GeoJSON Countries:", world.features.slice(0, 5).map(d => d.properties?.name));

            const countries = world.features.filter(d => d.properties?.name); // Ensure valid names
			console.log(" Filtered Countries Count:", countries.length);
			if (countries.length === 0) {
				console.error("  Error: No valid countries found in GeoJSON!");
			}
            const yearData = traffickingData.filter(d => d.Year === selectedYear);
            const incidentMap = {};
			
			// ====================== yearData ====

			yearData.forEach(d => {
				if (!d["Country"]) {
					console.error("  Missing Country Name in CSV Entry:", d); // Debugging log
					return;
				}
			
				const countryKey = standardizeCountryName(d["Country"]); //  Standardized key
			
				if (!countryKey) {
					console.error("  Standardized Country Name is Empty for:", d["Country"]);
					return;
				}
			
				incidentMap[countryKey] = {
					incidents: +d.Incidents,
					fine: d["Fine"],
					imprisonment: d["Imprisonment"]
				};
			});
			
			console.log(" Incident Map Keys:", Object.keys(incidentMap).slice(0, 5)); // Debugging log
			
			
	

            console.log(" Incident Map:", incidentMap);
			// Check the first country in the CSV data
			console.log(" First CSV Country:", Object.keys(incidentMap)[0]);
			console.log(" Sample CSV Countries:", Object.keys(incidentMap).slice(0, 5));			

			const incidents = Object.values(incidentMap).map(d => d.incidents).filter(d => d > 0);
			console.log(" Incident Values for Color Scale:", incidents);
			
			if (incidents.length === 0) {
				console.warn("  No valid incidents found, adding default values.");
				incidents.push(1); // Prevents color scale from breaking
			}
			
			const colorScale = d3.scaleQuantile()
				.domain(incidents)
				.range(["#ffffcc", "#ffeda0", "#feb24c", "#f03b20"]);
			
			

            svg.select("#countries").selectAll("path").remove();
			const paths = svg.select("#countries")
				.selectAll("path")
				.data(countries, d => standardizeCountryName(d.properties?.name));
			//if (paths.size() === 0) {
			//	console.error("  Error: No paths bound to countries. Check data binding.");
			//}
			
			console.log(" Paths Selection Count After Data Binding:", paths.size());
			
			paths.enter()
				.append("path")
				.merge(paths)
				.attr("d", path)
				.transition().duration(500)
				.attr("fill", d => {

				const value = incidentMap[standardizeCountryName(d.properties?.name)]?.incidents;
				//console.log(`  Coloring ${d.properties?.name} → ${standardizeCountryName(d.properties?.name)}: ${value}`); // Debugging log
				return value ? colorScale(value) : "#ccc";
				
				})
				.attr("stroke", "#000")
				.each(function(d) { 
					//console.log(" Adding event listener to:", d.properties?.name); // Debugging log
				});
			
			// ====================== mouseover ====

			paths.on("mouseover", function (event, d) {
				if (!d.properties || !d.properties.name) {
					console.warn("No country name found for:", d);
					return;
				}
				const countryName = standardizeCountryName(d.properties.name);
				const data = incidentMap[countryName] || { incidents: "N/A", fine: "N/A", imprisonment: "N/A" };
				
				d3.select("#tooltip")
					.style("opacity", 1)
					.html(`
						<strong>Country:</strong> ${d.properties.name} <br>
						<strong>Year:</strong> ${selectedYear} <br>
						<strong>Number of Incidents:</strong> ${incidentMap[d.properties.name]?.incidents || "N/A"}
						<strong>Avg Fine (USD):</strong> ${data.fine !== "N/A" ? parseFloat(data.fine).toFixed(2) : "N/A"} <br>
						<strong>Avg Imprisonment (Years):</strong> ${data.imprisonment !== "N/A" ? parseFloat(data.imprisonment).toFixed(2) : "N/A"}
   						
					`)
					.style("left", (event.pageX + 10) + "px")
					.style("top", (event.pageY - 28) + "px");				
			


			
				//console.log(`Tooltip Debug: Hovering over ${countryName} (Year: ${selectedYear})`);
				//console.log("Retrieved Data:", data);
			
				tooltip.transition().duration(200).style("opacity", 1);
				tooltip.html(`
					<strong>Country:</strong> ${countryName} <br>
					<strong>Year:</strong> ${selectedYear} <br>
					<strong>Incidents:</strong> ${data.incidents !== "N/A" ? data.incidents : "N/A"} <br>
					<strong>Avg Fine (USD):</strong> ${data.fine !== "N/A" ? data.fine.toFixed(2) : "N/A"} <br>
					<strong>Avg Imprisonment (Years):</strong> ${data.imprisonment !== "N/A" ? data.imprisonment.toFixed(2) : "N/A"}
				`)
				.style("left", (event.pageX + 10) + "px")
				.style("top", (event.pageY - 28) + "px");
			})
			.on("mouseout", function () {
				tooltip.transition().duration(500).style("opacity", 0);
			});



            console.log(" Colors Applied to Map!");
            createLegend(colorScale);
        }

        function createLegend(colorScale) {
            d3.select("#legend").selectAll("*").remove();

            d3.select("#legend")
                .attr("transform", "translate(50, 300)")
                .call(d3.legendColor()
                    .scale(colorScale)
                    .labelFormat(d3.format(".2f"))
                    .title("Number of Incidents"));
        }
    </script>

</body>
</html>