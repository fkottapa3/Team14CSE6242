import psycopg2
from flask import Flask, jsonify
from db_pg_connect import connect  # Import the connect function from db_pg_connect
from flask_cors import CORS

app = Flask(__name__)
CORS(app)

@app.route('/')
def home():
    return "Welcome to the Tenant API! Use /api/tenants to fetch data."

@app.route('/favicon.ico')
def favicon():
    return '', 204  # No Content


@app.route('/api/tenants', methods=['GET'])
def get_tenants():
    # Use the connect function to establish a database connection
    conn = connect()
    if not conn:
        return jsonify({"error": "Failed to connect to the database"}), 500

    try:
        cur = conn.cursor()
        # Fetch tenant data
        query = """
            SELECT
                tenant_name,
                tenant_address,
                admission_fee,
                agreed_rent,
                join_date
            FROM tenant_info
        """
        cur.execute(query)
        tenants = cur.fetchall()
        cur.close()
        conn.close()

        # Format the data as JSON
        return jsonify([
            {
                "tenant_name": row[0],
                "tenant_address": row[1],
                "admission_fee": float(row[2]) if row[2] is not None else 0.0,
                "agreed_rent": float(row[3]) if row[3] is not None else 0.0,
                "join_date": row[4].isoformat() if row[4] is not None else None  # Convert date to string
            }
            for row in tenants
        ])
    except Exception as e:
        # Handle query or database errors
        return jsonify({"error": str(e)}), 500

if __name__ == '__main__':
    app.run(debug=True)

